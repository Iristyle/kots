icon: https://github.com/okteto/polling/raw/master/icon.png
deploy:
  - envsubst < web/env/okteto.tmpl.js > web/env/skaffold.js

  - okteto build -f ./hack/dev/Dockerfile.okteto -t okteto.dev/kotsadm:${OKTETO_GIT_COMMIT} .
  - okteto build -f ./okteto.Dockerfile --build-arg OKTETO_NAMESPACE=${OKTETO_NAMESPACE} -t okteto.dev/kotsadm-web:${OKTETO_GIT_COMMIT} web
  - okteto build -f ./dev.Dockerfile -t okteto.dev/kotsadm-web:${OKTETO_NAMESPACE} web
  - okteto build -f ./migrations/Dockerfile.okteto -t okteto.dev/kotsadm-migrations:${OKTETO_GIT_COMMIT} migrations
  - okteto build -f ./kurl_proxy/Dockerfile.okteto -t okteto.dev/kurl_proxy:${OKTETO_GIT_COMMIT} kurl_proxy

  - cd kustomize/overlays/okteto && kustomize edit set image kotsadm=okteto.dev/kotsadm:${OKTETO_GIT_COMMIT}
  - cd kustomize/overlays/okteto && kustomize edit set image kotsadm-web=okteto.dev/kotsadm-web:${OKTETO_GIT_COMMIT}
  - cd kustomize/overlays/okteto && kustomize edit set image migrations=okteto.dev/kotsadm-migrations:${OKTETO_GIT_COMMIT}
  - cd kustomize/overlays/okteto && kustomize edit set image kurl_proxy=okteto.dev/kurl_proxy:${OKTETO_GIT_COMMIT}

  - kubectl apply -k kustomize/overlays/okteto
devs:
  - web/okteto.yml
